name: Deploy API to VPS

on:
  pull_request:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Run tests
        run: |
          if [ -d tests ]; then PYTHONPATH="${{ github.workspace }}:${PYTHONPATH}" pytest -q; else echo "No tests directory"; fi

      - name: Build Docker image
        run: docker build -t datamaq-communications-api:ci .

  deploy:
    runs-on: ubuntu-latest
    needs: ci
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Start ssh-agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.VPS_SSH_KEY }}
            ${{ secrets.GITHUB_DEPLOY_KEY }}

      - name: Add known hosts
        run: |
          mkdir -p ~/.ssh
          if [ -n "${{ secrets.VPS_KNOWN_HOSTS }}" ]; then
            echo "${{ secrets.VPS_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -p "${{ secrets.VPS_PORT }}" "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts
          fi

      - name: Preflight checks (runner)
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
          SMTP_TO_DEFAULT: ${{ secrets.SMTP_TO_DEFAULT }}
        run: |
          set -euo pipefail
          echo "Runner preflight started"
          echo "Repo: ${{ github.repository }}"
          echo "Ref: ${{ github.ref }}"
          echo "SHA: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          if [ -z "${SMTP_HOST}" ] || [ -z "${SMTP_FROM}" ] || [ -z "${SMTP_TO_DEFAULT}" ]; then
            echo "Missing required SMTP secrets on runner (SMTP_HOST/SMTP_FROM/SMTP_TO_DEFAULT)."
            exit 1
          fi
          echo "SMTP secret presence check: OK"
          echo "Known hosts entries on runner:"
          wc -l ~/.ssh/known_hosts || true

      - name: Deploy on VPS
        env:
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
          SMTP_TO_DEFAULT: ${{ secrets.SMTP_TO_DEFAULT }}
        run: |
          set -euo pipefail
          echo "Connecting to VPS host=${{ secrets.VPS_HOST }} port=${{ secrets.VPS_PORT }} user=${{ secrets.VPS_USER }}"
          ssh -A -p "${{ secrets.VPS_PORT }}" "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" \
            "SMTP_HOST='${SMTP_HOST}' SMTP_FROM='${SMTP_FROM}' SMTP_TO_DEFAULT='${SMTP_TO_DEFAULT}' bash -s" << 'EOF'
          set -euo pipefail
          echo "Remote preflight started"
          echo "host=$(hostname) user=$(whoami)"
          cd "${{ secrets.VPS_APP_DIR }}"
          echo "pwd=$(pwd)"
          ls -la | head -n 30

          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          if ! grep -q "github.com" ~/.ssh/known_hosts 2>/dev/null; then
            ssh-keyscan github.com >> ~/.ssh/known_hosts 2>/dev/null || true
          fi
          chmod 600 ~/.ssh/known_hosts 2>/dev/null || true

          echo "Testing GitHub SSH from VPS..."
          ssh -o StrictHostKeyChecking=accept-new -T git@github.com || true

          if ! GIT_SSH_COMMAND='ssh -o StrictHostKeyChecking=accept-new' git ls-remote --heads origin >/dev/null 2>&1; then
            echo "GitHub SSH auth failed on VPS (git ls-remote)."
            echo "Ensure one of these is configured:"
            echo "1) VPS user has a private key authorized for the repo, or"
            echo "2) GitHub secret GITHUB_DEPLOY_KEY is configured and ssh agent forwarding is allowed on VPS."
            echo "Current git remote config:"
            git remote -v || true
            exit 1
          fi

          echo "Git auth check OK"
          echo "Current commit before pull:"
          git rev-parse --short HEAD || true

          GIT_SSH_COMMAND='ssh -o StrictHostKeyChecking=accept-new' git pull --ff-only
          echo "Current commit after pull:"
          git rev-parse --short HEAD || true

          if [ ! -f .env ]; then
            cp .env.production.example .env
          fi

          upsert_env_var() {
            key="$1"
            value="$2"
            if grep -q "^${key}=" .env; then
              sed -i "s|^${key}=.*|${key}=${value}|" .env
            else
              printf "%s=%s\n" "$key" "$value" >> .env
            fi
          }

          if [ -n "${SMTP_HOST}" ]; then
            upsert_env_var "SMTP_HOST" "${SMTP_HOST}"
          fi
          if [ -n "${SMTP_FROM}" ]; then
            upsert_env_var "SMTP_FROM" "${SMTP_FROM}"
          fi
          if [ -n "${SMTP_TO_DEFAULT}" ]; then
            upsert_env_var "SMTP_TO_DEFAULT" "${SMTP_TO_DEFAULT}"
          fi

          missing=""
          for key in SMTP_HOST SMTP_FROM SMTP_TO_DEFAULT; do
            if ! grep -q "^${key}=" .env; then
              missing="${missing} ${key}"
            elif [ -z "$(grep "^${key}=" .env | head -n1 | cut -d'=' -f2-)" ]; then
              missing="${missing} ${key}"
            fi
          done

          if [ -n "${missing}" ]; then
            echo "Missing required SMTP env vars in .env:${missing}"
            echo "Define SMTP_HOST, SMTP_FROM and SMTP_TO_DEFAULT in GitHub Secrets."
            exit 1
          fi

          echo "SMTP env presence in .env:"
          grep -E '^(SMTP_HOST|SMTP_FROM|SMTP_TO_DEFAULT)=' .env | sed 's/=.*/=<set>/'

          echo "Docker versions:"
          docker --version || true
          docker compose version || true

          docker compose up -d --build
          docker compose ps
          for i in {1..20}; do
            if curl -fsS http://127.0.0.1:8000/telegram/last_chat >/dev/null; then
              echo "Healthcheck OK"
              break
            fi
            echo "Waiting API... attempt $i/20"
            sleep 2
            if [ "$i" -eq 20 ]; then
              echo "Healthcheck failed"
              docker compose ps
              docker compose logs --tail=200 api
              exit 1
            fi
          done

          echo "Running local CORS preflight check (/contact)..."
          local_cors_status=$(curl -sS -o /tmp/local_cors_body.txt -w "%{http_code}" -X OPTIONS \
            http://127.0.0.1:8000/contact \
            -H "Origin: https://datamaq.com.ar" \
            -H "Access-Control-Request-Method: POST")
          echo "Local CORS status=${local_cors_status}"
          if [ "${local_cors_status}" != "200" ] && [ "${local_cors_status}" != "204" ]; then
            echo "Local CORS preflight failed"
            cat /tmp/local_cors_body.txt || true
            exit 1
          fi

          echo "Running public CORS preflight check (https://api.datamaq.com.ar/contact)..."
          public_cors_status=$(curl -sS -o /tmp/public_cors_body.txt -w "%{http_code}" -X OPTIONS \
            https://api.datamaq.com.ar/contact \
            -H "Origin: https://datamaq.com.ar" \
            -H "Access-Control-Request-Method: POST")
          echo "Public CORS status=${public_cors_status}"
          if [ "${public_cors_status}" != "200" ] && [ "${public_cors_status}" != "204" ]; then
            echo "Public CORS preflight failed"
            cat /tmp/public_cors_body.txt || true
            exit 1
          fi

          contact_payload='{"name":"Smoke Test","email":"smoke@datamaq.com.ar","message":"smoke deploy check","meta":{"source":"deploy-workflow"},"attribution":{"website":""}}'

          echo "Running local contact POST check (expect 202)..."
          local_contact_status=$(curl -sS -o /tmp/local_contact_body.txt -w "%{http_code}" -X POST \
            http://127.0.0.1:8000/contact \
            -H "Content-Type: application/json" \
            -d "${contact_payload}")
          echo "Local contact status=${local_contact_status}"
          if [ "${local_contact_status}" != "202" ]; then
            echo "Local contact POST check failed"
            cat /tmp/local_contact_body.txt || true
            exit 1
          fi

          echo "Running public contact POST check (expect 202)..."
          public_contact_status=$(curl -sS -o /tmp/public_contact_body.txt -w "%{http_code}" -X POST \
            https://api.datamaq.com.ar/contact \
            -H "Content-Type: application/json" \
            -d "${contact_payload}")
          echo "Public contact status=${public_contact_status}"
          if [ "${public_contact_status}" != "202" ]; then
            echo "Public contact POST check failed"
            cat /tmp/public_contact_body.txt || true
            exit 1
          fi

          echo "Deploy validation OK"
          EOF
